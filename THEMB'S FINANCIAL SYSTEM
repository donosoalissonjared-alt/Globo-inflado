import sqlite3, os
from datetime import datetime
from flask import Flask, render_template_string, request, redirect, url_for, flash, g
from flask_login import (
    LoginManager, UserMixin, login_user, login_required, logout_user, current_user
)
from werkzeug.security import generate_password_hash, check_password_hash

app = Flask(__name__)
app.secret_key = "replace_this_secret_key"

DATABASE = "data.db"

login_manager = LoginManager()
login_manager.login_view = "login"
login_manager.init_app(app)


# ---------------- DATABASE ----------------
def get_db():
    db = getattr(g, "_database", None)
    if db is None:
        db = g._database = sqlite3.connect(DATABASE)
        db.row_factory = sqlite3.Row
    return db


@app.teardown_appcontext
def close_connection(exception=None):
    db = getattr(g, "_database", None)
    if db is not None:
        db.close()


def init_db():
    db = get_db()
    c = db.cursor()
    c.execute("""
    CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT UNIQUE NOT NULL,
        password_hash TEXT NOT NULL,
        role TEXT NOT NULL DEFAULT 'user'
    )
    """)
    c.execute("""
    CREATE TABLE IF NOT EXISTS entries (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        created_by INTEGER,
        created_at TEXT,
        field_a TEXT,
        field_b TEXT,
        amount REAL,
        notes TEXT,
        FOREIGN KEY(created_by) REFERENCES users(id)
    )
    """)
    db.commit()
    # default admin
    if not c.execute("SELECT * FROM users WHERE username='admin'").fetchone():
        c.execute("INSERT INTO users (username, password_hash, role) VALUES (?, ?, ?)",
                  ("admin", generate_password_hash("admin123"), "admin"))
        db.commit()


with app.app_context():
    init_db()


# ---------------- LOGIN ----------------
class User(UserMixin):
    def __init__(self, id_, username, role):
        self.id = id_
        self.username = username
        self.role = role

    @property
    def is_admin(self):
        return self.role == "admin"


@login_manager.user_loader
def load_user(user_id):
    db = get_db()
    u = db.execute("SELECT * FROM users WHERE id=?", (user_id,)).fetchone()
    return User(u["id"], u["username"], u["role"]) if u else None


# ---------------- ROUTES ----------------
@app.route("/")
def index():
    return redirect(url_for("dashboard") if current_user.is_authenticated else url_for("login"))


@app.route("/login", methods=["GET", "POST"])
def login():
    if request.method == "POST":
        username, password = request.form["username"], request.form["password"]
        db = get_db()
        u = db.execute("SELECT * FROM users WHERE username=?", (username,)).fetchone()
        if u and check_password_hash(u["password_hash"], password):
            login_user(User(u["id"], u["username"], u["role"]))
            flash("Login successful!", "success")
            return redirect(url_for("dashboard"))
        flash("Invalid credentials", "danger")
    return render_template_string(TEMPLATES["login"], **locals())


@app.route("/logout")
@login_required
def logout():
    logout_user()
    flash("Logged out.", "info")
    return redirect(url_for("login"))


@app.route("/dashboard")
@login_required
def dashboard():
    db = get_db()
    if current_user.is_admin:
        entries = db.execute("""
            SELECT e.*, u.username FROM entries e
            LEFT JOIN users u ON e.created_by=u.id
            ORDER BY e.created_at DESC
        """).fetchall()
    else:
        entries = db.execute("SELECT * FROM entries WHERE created_by=? ORDER BY created_at DESC",
                             (current_user.id,)).fetchall()
    return render_template_string(TEMPLATES["dashboard"], **locals())


@app.route("/new", methods=["GET", "POST"])
@login_required
def new_entry():
    if request.method == "POST":
        f = request.form
        try:
            amount = float(f.get("amount", 0))
        except ValueError:
            flash("Amount must be a number", "danger")
            return redirect(url_for("new_entry"))
        db = get_db()
        db.execute("""INSERT INTO entries (created_by, created_at, field_a, field_b, amount, notes)
                      VALUES (?, ?, ?, ?, ?, ?)""",
                   (current_user.id, datetime.utcnow().isoformat(),
                    f.get("field_a"), f.get("field_b"), amount, f.get("notes")))
        db.commit()
        flash("Entry saved.", "success")
        return redirect(url_for("dashboard"))
    return render_template_string(TEMPLATES["form"], **locals())


@app.route("/admin/users")
@login_required
def manage_users():
    if not current_user.is_admin:
        flash("Admin only.", "danger")
        return redirect(url_for("dashboard"))
    db = get_db()
    users = db.execute("SELECT * FROM users ORDER BY username").fetchall()
    return render_template_string(TEMPLATES["admin"], **locals())


@app.route("/admin/create", methods=["POST"])
@login_required
def create_user():
    if not current_user.is_admin:
        return redirect(url_for("dashboard"))
    u, p, r = request.form["username"], request.form["password"], request.form.get("role", "user")
    db = get_db()
    try:
        db.execute("INSERT INTO users (username, password_hash, role) VALUES (?, ?, ?)",
                   (u, generate_password_hash(p), r))
        db.commit()
        flash("User created.", "success")
    except sqlite3.IntegrityError:
        flash("Username already exists.", "danger")
    return redirect(url_for("manage_users"))


@app.route("/admin/delete/<int:uid>", methods=["POST"])
@login_required
def delete_user(uid):
    if not current_user.is_admin:
        return redirect(url_for("dashboard"))
    if uid == current_user.id:
        flash("You can't delete yourself.", "warning")
        return redirect(url_for("manage_users"))
    db = get_db()
    db.execute("DELETE FROM users WHERE id=?", (uid,))
    db.commit()
    flash("User deleted.", "info")
    return redirect(url_for("manage_users"))


@app.route("/health")
def health():
    return "OK", 200


# ---------------- HTML TEMPLATES ----------------
TEMPLATES = {}

TEMPLATES["base"] = """
<!doctype html><html lang='en'><head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<title>{{ title or 'Financial System' }}</title>
<link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css' rel='stylesheet'>
</head><body class='pt-5'>
<nav class='navbar navbar-expand-lg navbar-dark bg-dark fixed-top'>
  <div class='container-fluid'>
    <a class='navbar-brand' href='{{ url_for("dashboard") }}'>FinSystem</a>
    <div class='collapse navbar-collapse'>
      <ul class='navbar-nav ms-auto'>
        {% if current_user.is_authenticated %}
        <li class='nav-item'><a class='nav-link' href='{{ url_for("dashboard") }}'>Dashboard</a></li>
        <li class='nav-item'><a class='nav-link' href='{{ url_for("new_entry") }}'>New Entry</a></li>
        {% if current_user.is_admin %}
        <li class='nav-item'><a class='nav-link' href='{{ url_for("manage_users") }}'>Users</a></li>
        {% endif %}
        <li class='nav-item'><a class='nav-link' href='{{ url_for("logout") }}'>Logout ({{ current_user.username }})</a></li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>
<main class='container mt-4'>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for cat, msg in messages %}
      <div class='alert alert-{{cat}} alert-dismissible fade show' role='alert'>
        {{ msg }}<button type='button' class='btn-close' data-bs-dismiss='alert'></button>
      </div>
    {% endfor %}
  {% endwith %}
  {% block content %}{% endblock %}
</main>
<script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js'></script>
</body></html>
"""

TEMPLATES["login"] = """
{% extends TEMPLATES['base'] %}
{% block content %}
<div class='row justify-content-center'>
<div class='col-md-5'>
  <div class='card'><div class='card-body'>
  <h4 class='card-title mb-3'>Login</h4>
  <form method='post'>
    <input name='username' class='form-control mb-2' placeholder='Username' required>
    <input name='password' type='password' class='form-control mb-3' placeholder='Password' required>
    <button class='btn btn-primary w-100'>Login</button>
  </form>
  <hr><small>Default admin: <b>admin / admin123</b></small>
  </div></div>
</div></div>
{% endblock %}
"""

TEMPLATES["dashboard"] = """
{% extends TEMPLATES['base'] %}
{% block content %}
<h3>Dashboard</h3>
<p>Welcome <b>{{ current_user.username }}</b> {% if current_user.is_admin %}<span class='badge bg-success'>Admin</span>{% endif %}</p>
<a href='{{ url_for("new_entry") }}' class='btn btn-primary mb-3'>Add Entry</a>
<table class='table table-striped'>
<thead><tr><th>ID</th><th>Created At</th><th>By</th><th>Field A</th><th>Field B</th><th>Amount</th><th>Notes</th></tr></thead>
<tbody>
{% for e in entries %}
<tr>
<td>{{ e.id }}</td><td>{{ e.created_at }}</td>
<td>{{ e.username if e.get('username') else current_user.username }}</td>
<td>{{ e.field_a }}</td><td>{{ e.field_b }}</td>
<td>{{ '%.2f'|format(e.amount or 0) }}</td><td>{{ e.notes }}</td>
</tr>
{% else %}
<tr><td colspan='7' class='text-muted'>No entries</td></tr>
{% endfor %}
</tbody></table>
{% endblock %}
"""

TEMPLATES["form"] = """
{% extends TEMPLATES['base'] %}
{% block content %}
<h3>New Entry</h3>
<form method='post'>
  <div class='mb-2'><label>Field A</label><input name='field_a' class='form-control'></div>
  <div class='mb-2'><label>Field B</label><input name='field_b' class='form-control'></div>
  <div class='mb-2'><label>Amount</label><input name='amount' type='number' step='0.01' class='form-control'></div>
  <div class='mb-3'><label>Notes</label><textarea name='notes' class='form-control'></textarea></div>
  <button class='btn btn-success'>Save</button>
  <a href='{{ url_for("dashboard") }}' class='btn btn-secondary'>Cancel</a>
</form>
{% endblock %}
"""

TEMPLATES["admin"] = """
{% extends TEMPLATES['base'] %}
{% block content %}
<h3>Manage Users</h3>
<form class='row g-2 mb-3' method='post' action='{{ url_for("create_user") }}'>
  <div class='col'><input name='username' class='form-control' placeholder='Username' required></div>
  <div class='col'><input name='password' type='password' class='form-control' placeholder='Password' required></div>
  <div class='col'><select name='role' class='form-select'><option value='user'>User</option><option value='admin'>Admin</option></select></div>
  <div class='col-auto'><button class='btn btn-primary'>Create</button></div>
</form>
<table class='table table-bordered'><thead><tr><th>ID</th><th>Username</th><th>Role</th><th>Action</th></tr></thead>
<tbody>
{% for u in users %}
<tr>
<td>{{ u.id }}</td><td>{{ u.username }}</td><td>{{ u.role }}</td>
<td>
<form method='post' action='{{ url_for("delete_user", uid=u.id) }}' onsubmit='return confirm("Delete user?")'>
<button class='btn btn-sm btn-danger'>Delete</button>
</form>
</td>
</tr>
{% endfor %}
</tbody></table>
{% endblock %}
"""

# ---------------- RUN ----------------
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=3000)
